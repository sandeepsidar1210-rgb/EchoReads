<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search - EchoReads</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{background:radial-gradient(at 70% 30%, #171730, #0a0a1a);color:#e2e8f0;font-family:Inter,system-ui,sans-serif}</style>
</head>
<body class="min-h-screen">
  <header class="border-b border-slate-800/80 bg-slate-900/40 sticky top-0 z-40">
    <div class="container mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <button onclick="window.location.href='index.html'" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded">Back to Home Page</button>
        <a href="index.html" class="text-2xl font-bold text-amber-400">Echo<span class="text-white">Reads</span></a>
      </div>
      <nav class="space-x-6 text-gray-300">
        <a class="hover:text-white" href="browse.html">Browse</a>
        <a class="hover:text-white" href="genres.html">Genres</a>
        <a class="hover:text-white" href="cart.html">Cart</a>
        <a class="hover:text-white" href="novia.html">Novia</a>
      </nav>
    </div>
  </header>
  <main class="container mx-auto px-6 py-10">
    <h1 class="text-4xl font-extrabold text-white">Search</h1>
    <p class="text-gray-400">Search by title or author.</p>
    <div class="mt-6 flex gap-2 max-w-xl">
      <input id="q" class="flex-1 bg-gray-700 rounded px-4 py-2 text-white" placeholder="Type to search..." />
      <button id="go" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-500">Search</button>
    </div>
    <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8"></div>
    
    <!-- Purchase Modal -->
    <div id="purchase-modal" class="hidden fixed inset-0 z-50">
      <!-- populated by JS -->
    </div>
  </main>
  <script>
    const API='http://localhost:3000/api/books';
    async function fetchAll(){ const r=await fetch(API); const d=await r.json(); return d.data||[]; }
    function card(b){return `<div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg"><img src="${b.imageUrl}" class="w-full h-48 object-cover"/><div class="p-4"><h3 class="text-lg font-semibold text-white">${b.title}</h3><p class="text-gray-400">${b.author}</p><p class="text-amber-400 font-bold">$${b.price.toFixed(2)}</p><div class="mt-3 flex gap-2"><a class="bg-teal-600 hover:bg-teal-500 text-white px-3 py-1 rounded" href="browse.html?genre=${encodeURIComponent(b.genre)}">View</a><button onclick="openPurchase('${b._id}','${b.title.replace(/'/g, "\\'")}', ${b.price})" class="bg-amber-500 hover:bg-amber-400 text-black px-3 py-1 rounded font-semibold">Buy Now</button></div></div></div>`}
    async function search(){
      const q=document.getElementById('q').value.toLowerCase();
      const all=await fetchAll();
      const filtered=all.filter(b=> b.title.toLowerCase().includes(q) || b.author.toLowerCase().includes(q));
      document.getElementById('results').innerHTML=filtered.map(card).join('')||'<div class="text-gray-400">No results.</div>';
    }
    document.getElementById('go').onclick=search; document.getElementById('q').addEventListener('keypress',e=>{if(e.key==='Enter')search();});
    
    // Purchase helpers
    function currentUser(){ try { return JSON.parse(localStorage.getItem('echoreads_user')||'null'); } catch { return null; } }
    function openPurchase(bookId, title, price){
      const u=currentUser();
      if(!u){ alert('Please sign in first.'); window.location.href='signin.html'; return; }
      const modal=document.getElementById('purchase-modal');
      modal.innerHTML = `
        <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4">
          <div class="bg-gray-800 rounded-xl max-w-md w-full p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closePurchase()" class="absolute top-3 right-3 text-gray-400 hover:text-white">âœ•</button>
            <h3 class="text-xl font-bold mb-4">Purchase Book</h3>
            <div class="mb-4">
              <p class="text-gray-300 font-semibold">${title}</p>
              <p class="text-amber-400 text-2xl font-bold">$${price.toFixed(2)}</p>
            </div>
            <form id="purchase-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Full Name</label>
                <input type="text" id="purchase-name" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Address</label>
                <textarea id="purchase-address" rows="3" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Pincode</label>
                <input type="text" id="purchase-pincode" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Payment Method</label>
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="radio" id="upi" name="payment-method" value="UPI" class="mr-2">
                    <label for="upi" class="text-gray-300">UPI</label>
                  </div>
                  <div class="flex items-center">
                    <input type="radio" id="cod" name="payment-method" value="Cash on Delivery" class="mr-2" checked>
                    <label for="cod" class="text-gray-300">Cash on Delivery</label>
                  </div>
                </div>
              </div>
              <button type="submit" class="w-full bg-amber-500 hover:bg-amber-400 text-black font-semibold py-2 rounded">Complete Purchase</button>
            </form>
          </div>
        </div>`;
      modal.classList.remove('hidden');
      
      document.getElementById('purchase-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('purchase-name').value;
        const address = document.getElementById('purchase-address').value;
        const pincode = document.getElementById('purchase-pincode').value;
        const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
        
        try {
          const r = await fetch('http://localhost:3000/api/purchases', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-user-id': u.userId
            },
            body: JSON.stringify({
              bookId,
              price,
              name,
              address,
              pincode,
              paymentMethod
            })
          });
          const d = await r.json();
          if (!d.success) throw new Error(d.message || 'Purchase failed');
          alert('Purchase successful!');
          closePurchase();
        } catch (error) {
          alert('Purchase failed: ' + error.message);
        }
      });
    }
    function closePurchase(){ const modal=document.getElementById('purchase-modal'); modal.classList.add('hidden'); modal.innerHTML=''; }
  </script>
</body>
</html>
