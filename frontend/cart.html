<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoReads Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">EchoReads Shopping Cart</h1>
            <button onclick="window.location.href='index.html'" class="btn btn-primary">Back to Home Page</button>
        </div>

        <div id="cart-list" class="row">
            <!-- Cart items will be loaded here -->
        </div>

        <div id="cart-total" class="mt-4 text-end">
            <!-- Total will be shown here -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000/api';

        // Assume user is logged in and userId is stored in localStorage
        const userData = JSON.parse(localStorage.getItem('echoreads_user') || '{}');
        const userId = userData.userId || 'demo-user-id'; // Fallback for demo

        async function fetchCart() {
            try {
                const response = await fetch(`${API_BASE}/cart/mine?userId=${userId}`);
                const data = await response.json();
                if (data.success) {
                    displayCart(data.data);
                } else {
                    console.error('Failed to fetch cart:', data.message);
                }
            } catch (error) {
                console.error('Error fetching cart:', error);
            }
        }

        function displayCart(items) {
            const cartList = document.getElementById('cart-list');
            const cartTotal = document.getElementById('cart-total');
            cartList.innerHTML = '';

            if (items.length === 0) {
                cartList.innerHTML = '<div class="col-12"><p class="text-center">Your cart is empty.</p></div>';
                cartTotal.innerHTML = '';
                return;
            }

            let total = 0;
            items.forEach(item => {
                const itemTotal = item.book.price * item.quantity;
                total += itemTotal;
                const itemCard = `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${item.book.title}</h5>
                                <p class="card-text">
                                    <strong>Genre:</strong> ${item.book.genre}<br>
                                    <strong>Price:</strong> $${item.book.price}<br>
                                    <strong>Quantity:</strong> ${item.quantity}<br>
                                    <strong>Subtotal:</strong> $${itemTotal.toFixed(2)}
                                </p>
                                <button class="btn btn-danger" onclick="removeFromCart('${item._id}')">Remove</button>
                            </div>
                        </div>
                    </div>
                `;
                cartList.innerHTML += itemCard;
            });

            cartTotal.innerHTML = `<h4>Total: $${total.toFixed(2)}</h4><button class="btn btn-success" onclick="window.location.href='checkout.html'">Proceed to Checkout</button>`;
        }

        async function removeFromCart(itemId) {
            try {
                const response = await fetch(`${API_BASE}/cart/${itemId}`, {
                    method: 'DELETE',
                    headers: { 'x-user-id': userId }
                });
                const data = await response.json();
                if (data.success) {
                    fetchCart(); // Refresh cart
                } else {
                    alert('Failed to remove item');
                }
            } catch (error) {
                console.error('Error removing item:', error);
            }
        }

        // Load cart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetchCart();
        });
    </script>
</body>
</html>